---
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import ColumnArticle from "../../components/ColumnArticle.astro";
import {
  formatDateJa,
  getCategoryLabel,
  getCategorySlug,
  getColumnBySlug,
  getEyecatchUrl,
  getPublishedColumns,
  getTagEntries
} from "../../lib/microcms";

const slug = Astro.params.slug;
const draftKey = Astro.url.searchParams.get("draftKey") ?? undefined;

if (!slug) {
  return Astro.redirect("/knowledge");
}

let article = null;

try {
  article = await getColumnBySlug(slug, draftKey);
} catch (error) {
  console.error("[column] failed to fetch article", {
    slug,
    hasServiceDomain: Boolean(import.meta.env.MICROCMS_SERVICE_DOMAIN),
    hasApiKey: Boolean(import.meta.env.MICROCMS_API_KEY),
    error
  });
}

if (!article) {
  return new Response("Not Found", { status: 404 });
}

const pageTitle = `${article.title} | InsightBase コラム`;
const pageDescription = article.excerpt || "InsightBaseのコラム記事です。";
const ogImage = getEyecatchUrl(article.eyecatch) || undefined;
const baseUrl = Astro.site ?? Astro.url;
const articlePath = `/knowledge/${article.slug}`;
const articleUrl = new URL(articlePath, baseUrl).toString();
const firstTag = getTagEntries(article.tag)[0];
const articleCategory = getCategoryLabel(article.category);

const breadcrumbItems = [
  { name: "TOP", item: new URL("/", baseUrl).toString() },
  { name: "ナレッジベース", item: new URL("/knowledge", baseUrl).toString() },
  ...(firstTag
    ? [
        {
          name: firstTag.label,
          item: new URL(`/knowledge/tag/${encodeURIComponent(firstTag.slug)}`, baseUrl).toString()
        }
      ]
    : []),
  { name: article.title, item: articleUrl }
];

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: breadcrumbItems.map((entry, index) => ({
    "@type": "ListItem",
    position: index + 1,
    name: entry.name,
    item: entry.item
  }))
};

const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: article.title,
  description: pageDescription,
  datePublished: article.publishedAt || article.createdAt,
  dateModified: article.updatedAt,
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": articleUrl
  },
  author: {
    "@type": "Organization",
    name: "InsightBase"
  },
  publisher: {
    "@type": "Organization",
    name: "InsightBase",
    logo: {
      "@type": "ImageObject",
      url: new URL("/assets/img/logo/ogp.jpg", baseUrl).toString()
    }
  },
  ...(articleCategory ? { articleSection: articleCategory } : {}),
  ...(ogImage ? { image: [new URL(ogImage, baseUrl).toString()] } : {})
};

const currentCategorySlug = getCategorySlug(article.category);
const currentTagSlugs = new Set(getTagEntries(article.tag).map((tag) => tag.slug));

const relatedCandidates = await getPublishedColumns().catch((error) => {
  console.error("[column] failed to fetch related articles", {
    slug,
    hasServiceDomain: Boolean(import.meta.env.MICROCMS_SERVICE_DOMAIN),
    hasApiKey: Boolean(import.meta.env.MICROCMS_API_KEY),
    error
  });
  return [];
});

const scoredRelatedArticles = relatedCandidates
  .filter((item) => item.slug !== article.slug)
  .map((item) => {
    const tagSlugs = getTagEntries(item.tag).map((tag) => tag.slug);
    const sharedTagCount = tagSlugs.filter((tagSlug) => currentTagSlugs.has(tagSlug)).length;
    const hasSameCategory = Boolean(
      currentCategorySlug && getCategorySlug(item.category) === currentCategorySlug
    );
    const score = sharedTagCount * 3 + (hasSameCategory ? 2 : 0);
    const time = new Date(item.publishedAt || item.createdAt).getTime();
    return { item, score, time: Number.isNaN(time) ? 0 : time };
  });

const relatedArticles = (
  scoredRelatedArticles.some((entry) => entry.score > 0)
    ? scoredRelatedArticles.filter((entry) => entry.score > 0)
    : scoredRelatedArticles
)
  .sort((a, b) => b.score - a.score || b.time - a.time)
  .slice(0, 5)
  .map((entry) => entry.item);
---

<Layout
  title={pageTitle}
  description={pageDescription}
  ogType="article"
  ogImage={ogImage}
>
  {!draftKey && (
    <Fragment slot="head">
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
      <script type="application/ld+json" set:html={JSON.stringify(articleJsonLd)} />
    </Fragment>
  )}
  <ColumnArticle article={article} isPreview={Boolean(draftKey)} />
  {relatedArticles.length > 0 && (
    <section class="column-related">
      <div class="content__inner">
      <div class="--pt50"></div>
        <h2>関連記事</h2>
        <div class="column-related__cards">
          {relatedArticles.map((item) => (
            <a href={`/knowledge/${item.slug}`} class="column-hub-card">
              {getEyecatchUrl(item.eyecatch) && (
                <figure class="column-hub-card__thumb">
                  <img src={getEyecatchUrl(item.eyecatch)} alt={item.title} loading="lazy" />
                </figure>
              )}
              <div class="column-hub-card__body">
                <time datetime={item.publishedAt || item.createdAt}>
                  {formatDateJa(item.publishedAt || item.createdAt)}
                </time>
                <h3>{item.title}</h3>
                <p class="column-hub-card__category">{getCategoryLabel(item.category)}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</Layout>
<Footer />
