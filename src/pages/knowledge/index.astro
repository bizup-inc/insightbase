---
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import {
  formatDateJa,
  getCategorySlug,
  getCategoryLabel,
  getTagEntries,
  getEyecatchUrl,
  getPublishedColumns
} from "../../lib/microcms";

const columns = await getPublishedColumns().catch((error) => {
  console.error("[column] failed to fetch list", {
    hasServiceDomain: Boolean(import.meta.env.MICROCMS_SERVICE_DOMAIN),
    hasApiKey: Boolean(import.meta.env.MICROCMS_API_KEY),
    error
  });
  return [];
});

const categoryMap = new Map<string, string>();
columns.forEach((item) => {
  const categorySlug = getCategorySlug(item.category);
  const categoryLabel = getCategoryLabel(item.category);
  if (!categorySlug || !categoryLabel || categoryMap.has(categorySlug)) return;
  categoryMap.set(categorySlug, categoryLabel);
});
const categories = Array.from(categoryMap, ([slug, label]) => ({ slug, label }));

const tags = Array.from(
  new Set(
    columns
      .flatMap((item) => getTagEntries(item.tag))
      .map((tag) => `${tag.slug}|||${tag.label}`)
  )
).map((value) => {
  const [slug, label] = value.split("|||");
  return { slug, label };
});

const initialVisibleCount = 12;
---

<Layout
  title="ナレッジベース一覧 | InsightBase"
  description="InsightBaseのナレッジベース記事一覧です。"
>
  <Fragment slot="head">
    <style is:global>
      main {
        padding: 0 !important;
      }
    </style>
  </Fragment>

  <section class="column-hub">
    <div class="content__inner column-hub__inner">
      <header class="column-hub__header">
        <p class="column-hub__sub">Knowledge Base</p>
        <h1>ナレッジベース</h1>
      </header>

      <div class="column-hub__filters">
        <section class="column-filter-panel">
          <h2>CATEGORY <small>カテゴリ</small></h2>
          <div class="column-filter-panel__chips">
            {categories.map((category) => (
              <a href={`/knowledge/category/${encodeURIComponent(category.slug)}`}>{category.label}</a>
            ))}
          </div>
        </section>

        <section class="column-filter-panel">
          <h2>TAG <small>タグ</small></h2>
          <div class="column-filter-panel__chips column-filter-panel__chips--tags">
            {tags.map((tag) => (
              <a href={`/knowledge/tag/${encodeURIComponent(tag.slug)}`}>#{tag.label}</a>
            ))}
          </div>
        </section>
      </div>

      <section class="column-hub__latest">
        <h2>新着記事</h2>
        <div class="column-hub__cards">
          {columns.map((item, index) => (
            <a href={`/knowledge/${item.slug}`} class="column-hub-card" data-column-card hidden={index >= initialVisibleCount}>
              {getEyecatchUrl(item.eyecatch) && (
                <figure class="column-hub-card__thumb">
                  <img src={getEyecatchUrl(item.eyecatch)} alt={item.title} loading="lazy" />
                </figure>
              )}
              <div class="column-hub-card__body">
                <time datetime={item.publishedAt || item.createdAt}>
                  {formatDateJa(item.publishedAt || item.createdAt)}
                </time>
                <h3>{item.title}</h3>
                <p class="column-hub-card__category">{getCategoryLabel(item.category)}</p>
              </div>
            </a>
          ))}
        </div>
        {columns.length > initialVisibleCount && (
          <div class="column-hub__more">
            <button
              type="button"
              class="btn primary column-hub__more-btn"
              data-load-more
              data-step={String(initialVisibleCount)}
            >
              もっと見る
            </button>
          </div>
        )}
      </section>
    </div>
  </section>

  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const button = document.querySelector("[data-load-more]");
      if (!(button instanceof HTMLButtonElement)) return;

      const cards = Array.from(document.querySelectorAll("[data-column-card]"));
      const step = Number.parseInt(button.dataset.step || "12", 10);
      const initialVisibleIndex = cards.findIndex((card) => card.hasAttribute("hidden"));
      let visibleCount = initialVisibleIndex === -1 ? cards.length : initialVisibleIndex;

      const updateButton = () => {
        if (visibleCount >= cards.length) {
          button.style.display = "none";
        }
      };

      button.addEventListener("click", () => {
        const nextCount = Math.min(visibleCount + step, cards.length);
        for (let i = visibleCount; i < nextCount; i += 1) {
          cards[i].removeAttribute("hidden");
        }
        visibleCount = nextCount;
        updateButton();
      });

      updateButton();
    });
  </script>
</Layout>
<Footer />
