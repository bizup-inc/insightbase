---
import Layout from "../../../layouts/Layout.astro";
import Footer from "../../../components/Footer.astro";
import {
  formatDateJa,
  getCategorySlug,
  getCategoryLabel,
  getEyecatchUrl,
  getPublishedColumns,
  getPublishedColumnsByCategorySlug
} from "../../../lib/microcms";

const rawCategoryId = Astro.params.categoryId;

if (!rawCategoryId) {
  return new Response("Not Found", { status: 404 });
}

const categorySlug = decodeURIComponent(rawCategoryId);

const columns = await getPublishedColumnsByCategorySlug(categorySlug).catch((error) => {
  console.error("[column] failed to fetch category list", {
    categorySlug,
    hasServiceDomain: Boolean(import.meta.env.MICROCMS_SERVICE_DOMAIN),
    hasApiKey: Boolean(import.meta.env.MICROCMS_API_KEY),
    error
  });
  return [];
});

const categoryNameFromFilteredColumns = columns
  .map((item) => getCategoryLabel(item.category))
  .find((label) => Boolean(label) && label !== categorySlug);

const categoryNameFromAllColumns = categoryNameFromFilteredColumns
  ? ""
  : await getPublishedColumns()
      .then((allColumns) =>
        allColumns
          .filter((item) => getCategorySlug(item.category) === categorySlug)
          .map((item) => getCategoryLabel(item.category))
          .find((label) => Boolean(label) && label !== categorySlug) ?? ""
      )
      .catch(() => "");

const categoryName = categoryNameFromFilteredColumns || categoryNameFromAllColumns || categorySlug;
---

<Layout
  title={`${categoryName}の記事一覧 | InsightBase コラム`}
  description={`「${categoryName}」カテゴリの記事一覧です。`}
>
  <Fragment slot="head">
    <style is:global>
      main {
        padding: 0 !important;
      }
    </style>
  </Fragment>

  <section class="column-hub">
    <div class="content__inner column-hub__inner">
      <header class="column-hub__header">
        <p class="column-hub__sub">Knowledge Base</p>
        <h1>{categoryName}に関する記事一覧</h1>
      </header>

      <section class="column-hub__latest">

        <div class="column-hub__cards">
          {columns.map((item) => (
            <a href={`/column/${item.slug}`} class="column-hub-card">
              {getEyecatchUrl(item.eyecatch) && (
                <figure class="column-hub-card__thumb">
                  <img src={getEyecatchUrl(item.eyecatch)} alt={item.title} loading="lazy" />
                </figure>
              )}
              <div class="column-hub-card__body">
                <time datetime={item.publishedAt || item.createdAt}>
                  {formatDateJa(item.publishedAt || item.createdAt)}
                </time>
                <h3>{item.title}</h3>
                <p class="column-hub-card__category">{getCategoryLabel(item.category)}</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    </div>
  </section>
</Layout>
<Footer />
