---
import Layout from "../../../layouts/Layout.astro";
import Sidebar from "../../../components/Sidebar.astro";
import Footer from "../../../components/Footer.astro";
import {
  formatDateJa,
  getCategoryById,
  getCategoryLabel,
  getEyecatchUrl,
  getPublishedColumnsByCategory
} from "../../../lib/microcms";

const tagId = Astro.params.tagId;

if (!tagId) {
  return new Response("Not Found", { status: 404 });
}

const [columns, category] = await Promise.all([
  getPublishedColumnsByCategory(tagId).catch((error) => {
    console.error("[column] failed to fetch tag list", {
      tagId,
      hasServiceDomain: Boolean(import.meta.env.MICROCMS_SERVICE_DOMAIN),
      hasApiKey: Boolean(import.meta.env.MICROCMS_API_KEY),
      error
    });
    return [];
  }),
  getCategoryById(tagId).catch(() => null)
]);

const tagLabel = category
  ? category.name ?? category.title ?? category.label ?? category.id
  : tagId;
---

<Layout
  title={`タグ: ${tagLabel} | InsightBase コラム`}
  description={`「${tagLabel}」タグのコラム一覧です。`}
>
  <section class="column-page">
    <div class="content__inner column-page__inner">
      <article class="column-article">
        <header class="column-article__header">
          <h1>タグ: {tagLabel}</h1>
        </header>

        <div class="column-list">
          {columns.map((item) => (
            <a href={`/column/${item.slug}`} class="column-list__item">
              {getEyecatchUrl(item.eyecatch) && (
                <figure class="column-list__thumb">
                  <img src={getEyecatchUrl(item.eyecatch)} alt={item.title} loading="lazy" />
                </figure>
              )}
              <div class="column-list__meta">
                <p class="column-list__category">{getCategoryLabel(item.category)}</p>
                <time datetime={item.publishedAt || item.createdAt}>
                  {formatDateJa(item.publishedAt || item.createdAt)}
                </time>
              </div>
              <h2>{item.title}</h2>
            </a>
          ))}
        </div>
      </article>

      <Sidebar />
    </div>
  </section>
</Layout>
<Footer />
