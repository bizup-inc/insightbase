---
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import ColumnArticle from "../../components/ColumnArticle.astro";
import { getColumnBySlug, getEyecatchUrl } from "../../lib/microcms";

const slug = Astro.params.slug;
const draftKey = Astro.url.searchParams.get("draftKey") ?? undefined;

if (!slug) {
  return Astro.redirect("/column");
}

let article = null;

try {
  article = await getColumnBySlug(slug, draftKey);
} catch (error) {
  console.error("[column] failed to fetch article", {
    slug,
    hasServiceDomain: Boolean(import.meta.env.MICROCMS_SERVICE_DOMAIN),
    hasApiKey: Boolean(import.meta.env.MICROCMS_API_KEY),
    error
  });
}

if (!article) {
  return new Response("Not Found", { status: 404 });
}

const pageTitle = `${article.title} | InsightBase コラム`;
const pageDescription = article.excerpt || "InsightBaseのコラム記事です。";
const ogImage = getEyecatchUrl(article.eyecatch) || undefined;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  ogType="article"
  ogImage={ogImage}
>
  <ColumnArticle article={article} isPreview={Boolean(draftKey)} />
</Layout>
<Footer />
